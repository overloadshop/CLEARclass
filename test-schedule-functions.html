<!DOCTYPE html>
<html>
<head>
    <title>测试课程表导入导出功能</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { margin: 5px; padding: 10px 15px; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; }
    </style>
</head>
<body>
    <h1>课程表导入导出功能测试</h1>
    
    <div class="test-section">
        <h3>测试导出功能</h3>
        <button onclick="testExport()">测试导出CSV</button>
        <div id="exportResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>测试导入功能</h3>
        <input type="file" id="testFileInput" accept=".csv" onchange="testImport(event)">
        <div id="importResult" class="result"></div>
    </div>
    
    <script>
        // 模拟课程表数据
        const testScheduleData = {
            '0-0': '语文',
            '0-1': '数学',
            '0-2': '英语',
            '1-0': '数学',
            '1-1': '语文',
            '1-2': '物理'
        };
        
        const testTimeSlots = [
            { name: '第1节课', startTime: '08:00', endTime: '08:45', type: 'class' },
            { name: '第2节课', startTime: '08:55', endTime: '09:40', type: 'class' }
        ];
        
        const testWeekDays = ['周一', '周二', '周三'];
        
        function testExport() {
            try {
                const csv = generateCSVTemplate();
                downloadCSV(csv, '测试课程表.csv');
                document.getElementById('exportResult').innerHTML = '<span style="color: green;">✓ 导出功能正常</span>';
            } catch (error) {
                document.getElementById('exportResult').innerHTML = '<span style="color: red;">✗ 导出失败: ' + error.message + '</span>';
            }
        }
        
        function testImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        throw new Error('CSV文件格式不正确');
                    }
                    
                    const headers = parseCSVLine(lines[0]);
                    document.getElementById('importResult').innerHTML = '<span style="color: green;">✓ 导入功能正常，解析到表头: ' + headers.join(', ') + '</span>';
                } catch (error) {
                    document.getElementById('importResult').innerHTML = '<span style="color: red;">✗ 导入失败: ' + error.message + '</span>';
                }
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        // 复制Schedule.html中的函数
        function generateCSVTemplate() {
            let csv = '时间段,' + testWeekDays.join(',') + '\n';
            testTimeSlots.forEach((slot, slotIndex) => {
                let row = `"${slot.name} (${slot.startTime}-${slot.endTime})"`;
                testWeekDays.forEach((day, dayIndex) => {
                    const key = `${slotIndex}-${dayIndex}`;
                    const content = testScheduleData[key] || '';
                    row += ',"' + content.replace(/"/g, '""') + '"';
                });
                csv += row + '\n';
            });
            return csv;
        }
        
        function downloadCSV(content, filename) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
    </script>
</body>
</html>