<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班级管理系统 - 清空数据</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .clear-container {
            text-align: center;
            z-index: 10;
        }
        
        .clear-title {
            font-size: 28px;
            font-weight: 300;
            margin-bottom: 40px;
            opacity: 0;
            animation: fadeIn 1s ease-out 0.5s forwards;
        }
        
        .progress-container {
            width: 400px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 0 auto 30px;
            overflow: hidden;
            opacity: 0;
            animation: fadeIn 1s ease-out 1s forwards;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .loading-text {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            opacity: 0;
            animation: fadeIn 1s ease-out 1.5s forwards;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        

        
        @media (max-width: 768px) {
            .progress-container {
                width: 300px;
            }
            
            .clear-title {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>

    
    <div class="clear-container">
        <h1 class="clear-title">正在清空数据</h1>
        <div class="progress-container">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="loading-text" id="loadingText">准备开始...</div>
    </div>
    
    <script src="../security/security-system.js"></script>
    <script>

        
        // 获取数据大小（字节）
        function getDataSize(key) {
            const data = localStorage.getItem(key);
            return data ? new Blob([data]).size : 0;
        }
        
        // 计算总数据量
        function calculateTotalDataSize() {
            let totalSize = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                totalSize += getDataSize(key);
            }
            return totalSize;
        }
        
        // 根据数据大小计算清理时间（毫秒）
        function calculateClearTime(dataSize) {
            // 基础时间 500ms，每 1KB 数据增加 100ms，最小 300ms，最大 3000ms
            const baseTime = 500;
            const sizeInKB = dataSize / 1024;
            const additionalTime = Math.floor(sizeInKB * 100);
            return Math.max(300, Math.min(3000, baseTime + additionalTime));
        }
        
        // 清空数据流程
        async function startClearProcess() {
            // 首先进行安全验证
            const verified = await securitySystem.verifySensitiveOperation('清空所有数据');
            if (!verified) {
                // 验证失败，返回主页
                window.location.href = '../index.html';
                return;
            }
            
            // 验证通过，继续清空流程
            const progressFill = document.getElementById('progressFill');
            const loadingText = document.getElementById('loadingText');
            
            // 分析现有数据
            loadingText.textContent = '正在分析数据量...';
            await new Promise(resolve => setTimeout(resolve, 800));
            
            const totalDataSize = calculateTotalDataSize();
            const dataKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                dataKeys.push(localStorage.key(i));
            }
            
            // 准备清理步骤
            const steps = [];
            
            // 添加具体的数据项
            const keyMappings = {
                'classInfo': '班级信息',
                'studentList': '学生名单',
                'scheduleData': '课程表数据',
                'homeworkData': '作业记录',
                'noticeData': '通知公告',
                'dutyData': '值日安排',
                'systemSettings': '系统设置',
                'personnelConfig': '人员配置',
                'defaultBadgeConfig': '徽章配置',
                'classEmblem': '班级徽章',
                'securitySettings': '安全设置',
                'securityPasswordHash': '安全密码'
            };
            
            // 为每个存在的数据项创建清理步骤
            dataKeys.forEach(key => {
                const displayName = keyMappings[key] || key;
                const dataSize = getDataSize(key);
                const clearTime = calculateClearTime(dataSize);
                
                steps.push({
                    text: `正在清空${displayName}... (${(dataSize/1024).toFixed(1)}KB)`,
                    key: key,
                    size: dataSize,
                    time: clearTime
                });
            });
            
            // 如果没有数据，添加默认步骤
            if (steps.length === 0) {
                steps.push({
                    text: '正在清理系统缓存...',
                    key: 'empty',
                    size: 0,
                    time: 500
                });
            }
            
            // 添加最终清理步骤
            steps.push({
                text: '正在执行最终清理...',
                key: 'final',
                size: 0,
                time: 800
            });
            
            loadingText.textContent = `发现 ${dataKeys.length} 项数据，总计 ${(totalDataSize/1024).toFixed(1)}KB`;
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            let progress = 0;
            let clearedItems = 0;
            
            function clearStep(index) {
                if (index >= steps.length) {
                    finishClearProcess();
                    return;
                }
                
                const step = steps[index];
                loadingText.textContent = step.text;
                
                // 根据数据大小计算清理时间
                setTimeout(() => {
                    // 实际清空数据
                    if (step.key === 'final') {
                        // 最终清理：确保所有数据都被清空
                        localStorage.clear();
                        loadingText.textContent = '清理完成，正在验证...';
                    } else if (step.key !== 'empty') {
                        // 逐项清理
                        localStorage.removeItem(step.key);
                        clearedItems++;
                    }
                    
                    progress = ((index + 1) / steps.length) * 100;
                    progressFill.style.width = progress + '%';
                    
                    // 显示清理进度
                    if (step.key !== 'final' && step.key !== 'empty') {
                        setTimeout(() => {
                            loadingText.textContent = `已清理 ${clearedItems} 项数据`;
                        }, step.time * 0.3);
                    }
                    
                    // 继续下一步
                    setTimeout(() => clearStep(index + 1), step.time * 0.7);
                }, step.time * 0.3);
            }
            
            clearStep(0);
        }
        
        // 完成清空过程
        function finishClearProcess() {
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = '数据清空完成';
            
            // 清空完成后自动跳转到激活页面
            setTimeout(() => {
                loadingText.textContent = '正在跳转到激活页面...';
                setTimeout(() => {
                    window.location.href = '../Activate/first.html';
                }, 1000);
            }, 2000);
        }
        
        // 页面加载完成后开始清空流程
        window.addEventListener('load', function() {
            // 延迟开始清空流程，让动画先播放
            setTimeout(() => {
                startClearProcess();
            }, 2000);
        });
    </script>
</body>
</html>