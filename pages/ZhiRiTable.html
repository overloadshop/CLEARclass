<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€¼æ—¥ç”Ÿè¡¨ - ç­çº§ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../popup-system/popup-system.css">
    <script src="../security/security-system.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f7;
            color: #333;
            line-height: 1.6;
            padding: 5px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* æ·±è‰²ä¸»é¢˜æ ·å¼ */
        body.dark-theme {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        
        body.dark-theme .page-title {
            color: #ffffff;
        }
        
        body.dark-theme .control-card,
        body.dark-theme .settings-card,
        body.dark-theme .table-card {
            background: #2d2d2d;
            border-color: #555;
        }
        
        body.dark-theme .zhiri-table {
            background: #2d2d2d;
        }
        
        body.dark-theme .zhiri-table th,
        body.dark-theme .zhiri-table td {
            border-color: #555;
            color: #ffffff;
        }
        
        body.dark-theme .zhiri-table th {
            background: #3d3d3d;
        }
        
        body.dark-theme .time-slot {
            background: #3d3d3d;
            color: #ffffff;
        }
        
        body.dark-theme .duty-cell {
            background: #2d2d2d;
        }
        
        body.dark-theme .duty-cell:hover {
            background: #3d3d3d;
        }
        

        
        body.dark-theme .modal-content {
            background: #2d2d2d;
            color: #ffffff;
        }
        
        body.dark-theme .modal-header {
            background: #2d2d2d;
            border-color: #555;
        }
        
        body.dark-theme .modal-header h3 {
            color: #ffffff;
        }
        
        body.dark-theme .close {
            color: #ccc;
        }
        
        body.dark-theme .close:hover {
            color: #ffffff;
            background-color: #3d3d3d;
        }
        
        body.dark-theme .modal-footer {
            border-color: #555;
        }
        
        body.dark-theme .stat-value {
            color: #007aff;
        }
        
        body.dark-theme .stat-label {
            color: #ccc;
        }
        
        /* æ·±è‰²ä¸»é¢˜ä¸‹çš„å¡ç‰‡ç»„ä»¶ */
        body.dark-theme .control-card,
        body.dark-theme .settings-card,
        body.dark-theme .table-card {
            background: #2d2d2d;
            border-color: #555;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        body.dark-theme .zhiri-table {
            background: #2d2d2d;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        body.dark-theme .page-title {
            color: #ffffff;
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 0 5px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 600;
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        /* æ§åˆ¶å¡ç‰‡ */
        .control-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        
        .control-card .btn {
            white-space: nowrap;
        }

        /* è®¾ç½®å¡ç‰‡ */
        .settings-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        /* è¡¨æ ¼å¡ç‰‡ */
        .table-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
        }

        /* å€¼æ—¥ç”Ÿè¡¨æ ·å¼ */
        .zhiri-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .zhiri-table th,
        .zhiri-table td {
            border: 1px solid #e5e5e7;
            padding: 12px 8px;
            text-align: center;
            vertical-align: middle;
            position: relative;
            min-width: 100px;
        }

        .zhiri-table th:last-child,
        .zhiri-table td:last-child {
            border-right: none;
        }

        .zhiri-table tr:last-child td {
            border-bottom: none;
        }

        .zhiri-table th {
            background: #f6f6f6;
            font-weight: 600;
            color: #1d1d1f;
            font-size: 14px;
        }

        .time-slot {
            background: #f8f9fa;
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }

        .duty-cell {
            background: white;
            cursor: pointer;
            transition: background-color 0.2s ease;
            min-height: 60px;
            position: relative;
        }

        .duty-cell:hover {
            background: #f8f9fa;
        }

        .duty-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
            justify-content: center;
            min-height: 50px;
        }

        .duty-position {
            font-weight: 600;
            color: #007aff;
            font-size: 12px;
        }

        .duty-person {
            font-size: 14px;
            color: #333;
        }

        .duty-time {
            font-size: 10px;
            color: #666;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #4a90e2;
            color: white;
        }

        .btn-primary:hover {
            background: #357abd;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #1d1d1f;
        }

        .form-control, input[type="text"], input[type="time"], select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d1d6;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-control:focus, input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: #fff;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .close {
            color: #999;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .close:hover {
            color: #333;
            background-color: #f0f0f0;
        }
        
        .modal-body {
            padding: 20px 24px;
        }
        
        .modal-footer {
            padding: 16px 24px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* èŒä½åˆ—è¡¨æ ·å¼ */
        .position-list {
            min-height: 100px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #e5e5e7;
            border-radius: 6px;
            background: #fff;
        }

        .position-item {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e5e7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .position-item:last-child {
            border-bottom: none;
        }

        .position-name {
            font-weight: 500;
        }

        .position-actions {
            display: flex;
            gap: 5px;
        }





        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            
            .page-title {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .control-card {
                padding: 15px;
                gap: 10px;
            }
            
            .control-card .btn {
                font-size: 14px;
                padding: 8px 12px;
            }
            
            .zhiri-table th,
            .zhiri-table td {
                min-width: 80px;
                padding: 8px 4px;
                font-size: 12px;
            }
            
            .stats-info {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                padding: 15px;
            }
            
            .stat-item {
                padding: 8px;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            .stat-label {
                font-size: 12px;
            }
            
            .table-card {
                padding: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-info {
                grid-template-columns: 1fr;
            }
            
            .control-card {
                padding: 10px;
            }
            
            .control-card .btn {
                font-size: 13px;
                padding: 6px 10px;
            }
        }
        
        /* ç¼–è¾‘æ¨¡å¼æ ·å¼ */
        .edit-mode .duty-cell {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .edit-mode .duty-cell:hover {
            background-color: #f0f8ff !important;
            border: 2px solid #007bff;
        }
        
        .edit-controls {
            display: flex;
            gap: 10px;
            margin-left: 20px;
        }
        
        @media (max-width: 768px) {
            .edit-controls {
                margin-left: 0;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>


    <div class="container">
        <h1 class="page-title">å€¼æ—¥ç”Ÿè¡¨ç®¡ç†</h1>
        
        <!-- ç¼–è¾‘æ§åˆ¶æŒ‰é’® -->
        <div class="control-card">
            <button id="editModeBtn" class="btn btn-primary" onclick="toggleEditMode()" title="è¿›å…¥ç¼–è¾‘æ¨¡å¼">ç¼–è¾‘</button>
            <div id="editControls" class="edit-controls" style="display: none;">
                <button class="btn btn-success" onclick="saveDutyTable()" title="ä¿å­˜ä¿®æ”¹">ä¿å­˜</button>
                <button class="btn btn-secondary" onclick="cancelEdit()" title="æ’¤é”€ä¿®æ”¹">æ’¤é”€</button>
                <button class="btn btn-danger" onclick="exitEditMode()" title="é€€å‡ºç¼–è¾‘æ¨¡å¼">é€€å‡ºç¼–è¾‘</button>
            </div>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div id="dutyToolbar" class="control-card" style="display: none;">
                <button class="btn btn-info" onclick="showTimePeriodSettings()">æ—¶é—´ç®¡ç†</button>
                <button class="btn btn-secondary" onclick="showDutyItemSettings()">å€¼æ—¥é¡¹ç›®è®¾ç½®</button>
            <button class="btn btn-warning" onclick="exportDutyTable()">å¯¼å‡ºè¡¨æ ¼</button>
            <button class="btn btn-secondary" onclick="importDutyTable()">å¯¼å…¥è¡¨æ ¼</button>
            <button class="btn btn-danger" onclick="resetAllData()">é‡ç½®æ‰€æœ‰æ•°æ®</button>
            <button class="btn btn-danger" onclick="clearDutyTable()">æ¸…ç©ºè¡¨æ ¼</button>
            <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls" onchange="importDutyData(event)" style="display: none;">
        </div>



        <!-- å€¼æ—¥ç”Ÿè¡¨ -->
        <div class="table-card">
            <div class="table-container">
                <table class="zhiri-table" id="dutyTable">
                    <thead>
                        <tr>
                            <th>å€¼æ—¥é¡¹ç›®</th>
                            <!-- æ˜ŸæœŸåˆ—å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                        </tr>
                    </thead>
                    <tbody id="dutyTableBody">
                        <!-- è¡¨æ ¼å†…å®¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>



    <!-- æ—¶é—´æ®µè®¾ç½®æ¨¡æ€æ¡† -->
    <div id="timePeriodModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ—¶é—´ç®¡ç†</h3>
                <span class="close" onclick="closeTimePeriodModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="time-period-info" style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #666;"><i class="fas fa-info-circle"></i> æ—¶é—´æ®µé…ç½®å°†å½±å“å€¼æ—¥è¡¨çš„æ¨ªå‘ç»“æ„ï¼Œå»ºè®®ä¸è¯¾ç¨‹è¡¨ä¿æŒä¸€è‡´</p>
                </div>
                
                <!-- æ—¶é—´æ®µç®¡ç†å·¥å…·æ  -->
                <div class="time-period-toolbar" style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-info" onclick="syncFromSchedule()">åŒæ­¥è¯¾ç¨‹è¡¨</button>
                    <button class="btn btn-success" onclick="exportTimePeriods()">å¯¼å‡ºæ—¶é—´æ®µ</button>
                    <button class="btn btn-secondary" onclick="importTimePeriods()">å¯¼å…¥æ—¶é—´æ®µ</button>
                    <button class="btn btn-danger" onclick="clearAllTimePeriods()">æ¸…ç©ºæ‰€æœ‰</button>
                    <input type="file" id="timePeriodFileInput" accept=".json" onchange="importTimePeriodData(event)" style="display: none;">
                </div>
                
                <div class="time-period-list" id="timePeriodList">
                    <!-- æ—¶é—´æ®µåˆ—è¡¨ -->
                </div>
                
                <div class="add-time-period">
                    <h4>æ·»åŠ æ–°æ—¶é—´æ®µ</h4>
                    <div class="form-row" style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group" style="flex: 2;">
                            <label>æ—¶é—´æ®µåç§°:</label>
                            <input type="text" id="timePeriodName" placeholder="å¦‚ï¼šç¬¬1èŠ‚ã€è¯¾é—´æ“ã€åˆä¼‘ç­‰">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>å¼€å§‹æ—¶é—´:</label>
                            <input type="time" id="timePeriodStart">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>ç»“æŸæ—¶é—´:</label>
                            <input type="time" id="timePeriodEnd">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ—¶é—´æ®µç±»å‹:</label>
                        <select id="timePeriodType">
                            <option value="class">ä¸Šè¯¾æ—¶é—´</option>
                            <option value="break">è¯¾é—´ä¼‘æ¯</option>
                            <option value="activity">æ´»åŠ¨æ—¶é—´</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="addNewTimePeriod()">æ·»åŠ æ—¶é—´æ®µ</button>
                        <button class="btn btn-secondary" onclick="clearTimePeriodForm()">æ¸…ç©ºè¡¨å•</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å€¼æ—¥é¡¹ç›®è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="dutyItemModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>å€¼æ—¥é¡¹ç›®è®¾ç½®</h3>
                <span class="close" onclick="closeDutyItemModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="duty-item-info" style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h5 style="margin: 0 0 10px 0; color: #495057;">ğŸ’¡ å€¼æ—¥é¡¹ç›®è¯´æ˜</h5>
                    <p style="margin: 0; color: #6c757d; font-size: 14px;">ä»å€™é€‰é¡¹ç›®ä¸­é€‰æ‹©æ·»åŠ åˆ°æ—¶é—´æ®µï¼Œæˆ–åˆ›å»ºæ–°çš„å€¼æ—¥é¡¹ç›®ã€‚</p>
                </div>
                
                <div id="dutyItemList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                    <!-- å€¼æ—¥é¡¹ç›®åˆ—è¡¨ -->
                </div>
                
                <div class="add-duty-item" style="border-top: 1px solid #dee2e6; padding-top: 20px;">
                    <div style="display: flex; gap: 10px; align-items: end;">
                        <div style="flex: 1;">
                            <label>é¡¹ç›®åç§°</label>
                            <input type="text" id="dutyItemName" class="form-control" placeholder="å¦‚ï¼šæ‰«åœ°ã€æ“¦é»‘æ¿ã€å€’åƒåœ¾ç­‰" list="dutyItemSuggestions">
                            <datalist id="dutyItemSuggestions">
                                <option value="æ‰«åœ°">
                                <option value="æ“¦é»‘æ¿">
                                <option value="å€’åƒåœ¾">
                                <option value="æ•´ç†è®²å°">
                                <option value="å…³çª—é”é—¨">
                                <option value="å¼€å…³ç¯">
                                <option value="æ“¦çª—æˆ·">
                                <option value="æ‹–åœ°">
                                <option value="æ•´ç†æ¡Œæ¤…">
                                <option value="æ”¶å‘ä½œä¸š">
                                <option value="ç»´æŠ¤çºªå¾‹">
                                <option value="æ£€æŸ¥å«ç”Ÿ">
                                <option value="æ¸…ç†åƒåœ¾æ¡¶">
                                <option value="æ•´ç†ä¹¦æ¶">
                                <option value="æ“¦æ‹­é—¨çª—">
                                <option value="æ¸…æ´é¥®æ°´æœº">
                                <option value="æ•´ç†æ•™å…·">
                                <option value="æ£€æŸ¥ç”µå™¨">
                            </datalist>
                        </div>
                        <button class="btn btn-primary" onclick="addDutyItem()" style="height: 38px;">+</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ—¶é—´æ®µåˆ—è¡¨æ¨¡æ€æ¡† -->
    <div id="timeSlotListModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>é€‰æ‹©æ—¶é—´æ®µ</h3>
                <span class="close" onclick="closeTimeSlotListModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="time-slot-info" style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h5 style="margin: 0 0 10px 0; color: #495057;">ğŸ’¡ æ—¶é—´æ®µè¯´æ˜</h5>
                    <p style="margin: 0; color: #6c757d; font-size: 14px;">ä»å€™é€‰æ—¶é—´æ®µä¸­é€‰æ‹©æ·»åŠ åˆ°è¡¨æ ¼ï¼Œæˆ–åˆ›å»ºæ–°çš„æ—¶é—´æ®µã€‚</p>
                </div>
                
                <div id="timeSlotList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                    <!-- æ—¶é—´æ®µåˆ—è¡¨ -->
                </div>
                
                <div class="add-time-slot" style="border-top: 1px solid #dee2e6; padding-top: 20px;">
                    <div style="display: flex; gap: 10px; align-items: end;">
                        <div style="flex: 1;">
                            <label>æ—¶é—´æ®µåç§°</label>
                            <input type="text" id="timeSlotName" class="form-control" placeholder="å¦‚ï¼šæ—©è¯»ã€åˆä¼‘ã€è¯¾é—´ã€æ”¾å­¦ç­‰" list="timeSlotSuggestions">
                            <datalist id="timeSlotSuggestions">
                                <option value="æ—©è¯»">
                                <option value="åˆä¼‘">
                                <option value="è¯¾é—´">
                                <option value="æ”¾å­¦">
                                <option value="æ™šè‡ªä¹ ">
                                <option value="å¤§è¯¾é—´">
                                <option value="çœ¼ä¿å¥æ“">
                                <option value="å‡æ——ä»ªå¼">
                                <option value="é›†ä¼šæ—¶é—´">
                                <option value="è¯¾å‰å‡†å¤‡">
                                <option value="è¯¾åæ•´ç†">
                                <option value="ä½“è‚²è¯¾">
                                <option value="å®éªŒè¯¾">
                                <option value="éŸ³ä¹è¯¾">
                                <option value="ç¾æœ¯è¯¾">
                                <option value="ç­ä¼šè¯¾">
                                <option value="è‡ªä¹ è¯¾">
                            </datalist>
                        </div>
                        <div style="flex: 1;">
                            <label>å¼€å§‹æ—¶é—´</label>
                            <input type="time" id="timeSlotStart" class="form-control">
                        </div>
                        <div style="flex: 1;">
                            <label>ç»“æŸæ—¶é—´</label>
                            <input type="time" id="timeSlotEnd" class="form-control">
                        </div>
                        <button class="btn btn-primary" onclick="addTimeSlotFromList()" style="height: 38px;">+</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å€¼æ—¥åˆ†é…æ¨¡æ€æ¡† -->
    <div id="assignModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>åˆ†é…å€¼æ—¥</h3>
                <span class="close" onclick="closeAssignModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>é€‰æ‹©èŒä½:</label>
                    <select id="assignPosition" class="form-control">
                        <option value="ç»„é•¿">ç»„é•¿</option>
                        <option value="æ™®é€šæˆå‘˜" selected>æ™®é€šæˆå‘˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©å­¦ç”Ÿ:</label>
                    <input type="text" id="assignStudent" class="form-control" placeholder="è¯·è¾“å…¥æˆ–é€‰æ‹©å­¦ç”Ÿå§“å" list="studentSuggestions">
                    <datalist id="studentSuggestions">
                        <!-- åŠ¨æ€ç”Ÿæˆå­¦ç”Ÿåˆ—è¡¨ -->
                    </datalist>
                </div>
                <div class="form-group">
                    <label>è´Ÿè´£æ—¶é—´:</label>
                    <input type="text" id="assignTime" placeholder="ä¾‹å¦‚ï¼š08:00-12:00">
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" onclick="confirmAssign()">ç¡®è®¤åˆ†é…</button>
                    <button class="btn btn-secondary" onclick="closeAssignModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../popup-system/toast.js"></script>
    <script src="../popup-system/confirm.js"></script>
    <script src="../popup-system/modal.js"></script>
    <script src="../Cache/StudentListCache.js"></script>
    <script src="../Cache/DutyDataCache.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let weekDays = [];
        let currentCell = null;
        let customTimePeriods = []; // è‡ªå®šä¹‰æ—¶é—´æ®µ

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadScheduleStructure();
            loadTimePeriods();
            renderTimePeriodList();
            renderDutyTable();
        });
        
        // ç›‘å¬ç¼“å­˜æ•°æ®å˜æ›´
        dutyDataCache.onChange(function(event) {
            console.log('å€¼æ—¥æ•°æ®å˜æ›´:', event.detail);
            renderDutyTable();
        });
        
        studentListCache.onChange(function(event) {
            console.log('å­¦ç”Ÿåå•å˜æ›´:', event.detail);
            // é‡æ–°å¡«å……å­¦ç”Ÿé€‰é¡¹
            const studentInput = document.getElementById('assignStudent');
            if (studentInput) {
                updateStudentSuggestions();
            }
        });
        
        // æ›´æ–°å­¦ç”Ÿå»ºè®®åˆ—è¡¨
        function updateStudentSuggestions() {
            const datalist = document.getElementById('studentSuggestions');
            if (!datalist) return;
            
            const students = studentListCache.getAll();
            datalist.innerHTML = '';
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student;
                datalist.appendChild(option);
            });
        }
        
        // åŠ è½½å€™é€‰æ—¶é—´æ®µ
        function loadAvailableTimeSlots() {
            try {
                const saved = localStorage.getItem('availableTimeSlots');
                if (saved) {
                    availableTimeSlots = JSON.parse(saved);
                } else {
                    // é»˜è®¤ä¸ºç©ºï¼Œç”¨æˆ·è‡ªè¡Œæ·»åŠ 
                    availableTimeSlots = [];
                    localStorage.setItem('availableTimeSlots', JSON.stringify(availableTimeSlots));
                }
            } catch (e) {
                console.error('åŠ è½½å€™é€‰æ—¶é—´æ®µå¤±è´¥:', e);
                availableTimeSlots = [];
            }
        }
        
        // åŠ è½½å€™é€‰å€¼æ—¥é¡¹ç›®
        function loadAvailableDutyItems() {
            try {
                const saved = localStorage.getItem('availableDutyItems');
                if (saved) {
                    availableDutyItems = JSON.parse(saved);
                } else {
                    // é»˜è®¤ä¸ºç©ºï¼Œç”¨æˆ·è‡ªè¡Œæ·»åŠ 
                    availableDutyItems = [];
                    localStorage.setItem('availableDutyItems', JSON.stringify(availableDutyItems));
                }
            } catch (e) {
                console.error('åŠ è½½å€™é€‰å€¼æ—¥é¡¹ç›®å¤±è´¥:', e);
                availableDutyItems = [];
            }
        }

        // åŠ è½½å€¼æ—¥ç”Ÿè¡¨ç»“æ„ï¼ˆç‹¬ç«‹äºè¯¾ç¨‹è¡¨ï¼‰
        function loadScheduleStructure() {
            try {
                // å€¼æ—¥ç”Ÿè¡¨ä½¿ç”¨ç‹¬ç«‹çš„æ˜ŸæœŸé…ç½®
                const savedWeekDays = localStorage.getItem('dutyWeekDays');
                if (savedWeekDays) {
                    weekDays = JSON.parse(savedWeekDays);
                } else {
                    // å€¼æ—¥ç”Ÿè¡¨é»˜è®¤å·¥ä½œæ—¥
                    weekDays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”'];
                    localStorage.setItem('dutyWeekDays', JSON.stringify(weekDays));
                }
            } catch (e) {
                console.error('åŠ è½½å€¼æ—¥ç”Ÿè¡¨ç»“æ„å¤±è´¥:', e);
                // ä½¿ç”¨é»˜è®¤å€¼
                weekDays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”'];
                localStorage.setItem('dutyWeekDays', JSON.stringify(weekDays));
            }
        }

        // åŠ è½½å€¼æ—¥æ•°æ®ï¼ˆä½¿ç”¨ç¼“å­˜ç³»ç»Ÿï¼‰
        function loadDutyData() {
            // ç¼“å­˜ç³»ç»Ÿè‡ªåŠ¨åŠ è½½ï¼Œè¿™é‡Œåªæ˜¯å…¼å®¹æ€§å‡½æ•°
            return dutyDataCache.getDutyData();
        }

        // ä¿å­˜å€¼æ—¥æ•°æ®ï¼ˆä½¿ç”¨ç¼“å­˜ç³»ç»Ÿï¼‰
        function saveDutyData() {
            // ç¼“å­˜ç³»ç»Ÿè‡ªåŠ¨ä¿å­˜ï¼Œè¿™é‡Œåªæ˜¯å…¼å®¹æ€§å‡½æ•°
            return dutyDataCache.save();
        }

        // åŠ è½½èŒä½æ•°æ®ï¼ˆä½¿ç”¨ç¼“å­˜ç³»ç»Ÿï¼‰
        function loadPositions() {
            return dutyDataCache.getDutyPositions();
        }

        // ä¿å­˜èŒä½æ•°æ®ï¼ˆä½¿ç”¨ç¼“å­˜ç³»ç»Ÿï¼‰
        function savePositions() {
            return dutyDataCache.save();
        }

        // åŠ è½½å­¦ç”Ÿæ•°æ®ï¼ˆä½¿ç”¨ç¼“å­˜ç³»ç»Ÿï¼‰
        function loadStudents() {
            return studentListCache.getAll();
        }

        // æ¸²æŸ“å€¼æ—¥ç”Ÿè¡¨
        function renderDutyTable() {
            const table = document.getElementById('dutyTable');
            if (!table) return;
            
            // ä»ç¼“å­˜è·å–æ•°æ®
            const timeSlots = dutyDataCache.getTimeSlots();
            const dutyData = dutyDataCache.getDutyData();
            
            // é‡æ–°ç”Ÿæˆè¡¨å¤´ - æŒ‰æ—¶é—´æ®µåˆ†ç»„
            const thead = table.querySelector('thead');
            if (thead) {
                const headerRow = thead.querySelector('tr');
                headerRow.innerHTML = '<th style="width: 120px;">æ—¶é—´æ®µ/é¡¹ç›®</th>';
                weekDays.forEach(day => {
                    const th = document.createElement('th');
                    th.textContent = day;
                    th.style.width = '100px';
                    headerRow.appendChild(th);
                });
            }
            
            // ç”Ÿæˆè¡¨æ ¼å†…å®¹ - æŒ‰æ—¶é—´æ®µåˆ†ç»„æ˜¾ç¤º
            const tbody = document.getElementById('dutyTableBody');
            tbody.innerHTML = '';
            
            // æŒ‰æ—¶é—´æ®µåˆ†ç»„
            timeSlots.forEach((timeSlot, timeIndex) => {
                // æ—¶é—´æ®µæ ‡é¢˜è¡Œ
                const timeRow = document.createElement('tr');
                timeRow.className = 'time-group-header';
                
                const timeCell = document.createElement('td');
                timeCell.style.cssText = 'font-weight: bold; background: #007aff; color: white; padding: 8px; position: relative;';
                
                if (isEditMode) {
                    timeCell.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${timeSlot.name} (${timeSlot.start}-${timeSlot.end})</span>
                            <button class="btn btn-danger" onclick="removeTimeSlotFromTable(${timeIndex})" 
                                    style="padding: 2px 6px; font-size: 11px; margin-left: 10px;" 
                                    title="åˆ é™¤æ—¶é—´æ®µ">
                                âœ•
                            </button>
                        </div>
                    `;
                } else {
                    timeCell.textContent = `${timeSlot.name} (${timeSlot.start}-${timeSlot.end})`;
                }
                
                timeRow.appendChild(timeCell);
                
                // æ—¶é—´æ®µæ ‡é¢˜çš„æ˜ŸæœŸåˆ—
                weekDays.forEach(() => {
                    const cell = document.createElement('td');
                    cell.style.cssText = 'background: #007aff; border-left: 1px solid #0056b3;';
                    timeRow.appendChild(cell);
                });
                
                tbody.appendChild(timeRow);
                
                // è·å–è¯¥æ—¶é—´æ®µçš„å€¼æ—¥é¡¹ç›®
                const timeSlotItems = getItemsForTimeSlot(timeIndex);
                
                if (timeSlotItems.length === 0) {
                    // ç©ºæ—¶é—´æ®µï¼Œæ˜¾ç¤ºæ·»åŠ é¡¹ç›®æŒ‰é’®
                    const emptyRow = document.createElement('tr');
                    const emptyCell = document.createElement('td');
                    emptyCell.colSpan = weekDays.length + 1;
                    emptyCell.style.cssText = 'text-align: center; padding: 20px; background: #f8f9fa; border: 2px dashed #ddd;';
                    
                    if (isEditMode) {
                        emptyCell.innerHTML = `
                            <button class="btn btn-primary" onclick="addItemToTimeSlot(${timeIndex})" style="border-radius: 20px;">
                                <i class="fas fa-plus"></i> æ·»åŠ å€¼æ—¥é¡¹ç›®
                            </button>
                        `;
                    } else {
                        emptyCell.innerHTML = '<span style="color: #999;">è¯¥æ—¶é—´æ®µæš‚æ— å€¼æ—¥é¡¹ç›®</span>';
                    }
                    
                    emptyRow.appendChild(emptyCell);
                    tbody.appendChild(emptyRow);
                } else {
                    // æ˜¾ç¤ºè¯¥æ—¶é—´æ®µçš„å€¼æ—¥é¡¹ç›®
                    timeSlotItems.forEach((itemName, itemIndex) => {
                        const row = document.createElement('tr');
                        row.className = 'duty-item-row';
                        
                        // å€¼æ—¥é¡¹ç›®åˆ—
                        const itemCell = document.createElement('td');
                        itemCell.style.cssText = 'padding-left: 20px; font-weight: 500; background: #f8f9fa;';
                        itemCell.innerHTML = `<span style="color: #666;">â”œ ${itemName}</span>`;
                        row.appendChild(itemCell);
                        
                        // æ˜ŸæœŸåˆ—
                        weekDays.forEach((day, dayIndex) => {
                            const cell = document.createElement('td');
                            cell.className = 'duty-cell';
                            cell.setAttribute('data-time', timeIndex);
                            cell.setAttribute('data-item', itemName);
                            cell.setAttribute('data-day', dayIndex);
                            
                            // æŸ¥æ‰¾åˆ†é…æƒ…å†µ
                            const key = `${timeIndex}-${dayIndex}`;
                            const dutyInfo = dutyData[key];
                            let assignedPerson = '';
                            let assignedPosition = '';
                            
                            if (dutyInfo && dutyInfo.item === itemName) {
                                assignedPerson = dutyInfo.person || '';
                                assignedPosition = dutyInfo.position || '';
                            }
                            
                            if (assignedPerson) {
                                const displayText = assignedPosition ? `${assignedPosition}: ${assignedPerson}` : assignedPerson;
                                cell.innerHTML = `
                                    <div class="duty-content">
                                        <div class="duty-person" style="font-weight: 500;">${displayText}</div>
                                    </div>
                                `;
                                cell.style.backgroundColor = '#e8f5e8';
                            } else {
                                if (isEditMode) {
                                    cell.innerHTML = `
                                        <div class="duty-content">
                                            <div style="color: #999; font-size: 12px;">ç‚¹å‡»åˆ†é…</div>
                                        </div>
                                    `;
                                } else {
                                    cell.innerHTML = `
                                        <div class="duty-content">
                                            <div style="color: #ccc; font-size: 12px;">æœªåˆ†é…</div>
                                        </div>
                                    `;
                                 }
                             }
                             
                             // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                             if (isEditMode) {
                                 cell.style.cursor = 'pointer';
                                 cell.onclick = () => openAssignModal(timeIndex, dayIndex, itemName);
                             }
                             
                             row.appendChild(cell);
                         });
                         
                         tbody.appendChild(row);
                     });
                     
                     // åœ¨å·²æœ‰é¡¹ç›®çš„æ—¶é—´æ®µæœ«å°¾æ·»åŠ "æ·»åŠ æ›´å¤šé¡¹ç›®"æŒ‰é’®ï¼ˆåªåœ¨ç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºï¼‰
                     if (isEditMode) {
                         const addMoreRow = document.createElement('tr');
                         const addMoreCell = document.createElement('td');
                         addMoreCell.colSpan = weekDays.length + 1;
                         addMoreCell.style.cssText = 'text-align: center; padding: 10px; background: #f8f9fa; border: 1px dashed #ccc;';
                         addMoreCell.innerHTML = `
                             <button class="btn btn-outline-primary btn-sm" onclick="addItemToTimeSlot(${timeIndex})" style="border-radius: 15px; font-size: 12px;">
                                 <i class="fas fa-plus"></i> æ·»åŠ æ›´å¤šé¡¹ç›®
                             </button>
                         `;
                         addMoreRow.appendChild(addMoreCell);
                         tbody.appendChild(addMoreRow);
                     }
                 }
             });
             
             // æ·»åŠ æ–°æ—¶é—´æ®µæŒ‰é’®ï¼ˆåªåœ¨ç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºï¼‰
             if (isEditMode) {
                 const addTimeRow = document.createElement('tr');
                 const addTimeCell = document.createElement('td');
                 addTimeCell.colSpan = weekDays.length + 1;
                 addTimeCell.style.cssText = 'text-align: center; padding: 15px; background: #f0f8ff; border: 2px dashed #007aff;';
                 addTimeCell.innerHTML = `
                     <button class="btn btn-outline-primary" onclick="addNewTimeSlot()" style="border-radius: 20px;">
                         <i class="fas fa-plus"></i> æ·»åŠ æ—¶é—´æ®µ
                     </button>
                 `;
                 addTimeRow.appendChild(addTimeCell);
                 tbody.appendChild(addTimeRow);
             }
        }
        
        // è·å–æŒ‡å®šæ—¶é—´æ®µçš„å€¼æ—¥é¡¹ç›®
        function getItemsForTimeSlot(timeIndex) {
            const dutyData = dutyDataCache.getDutyData();
            const items = new Set();
            weekDays.forEach((day, dayIndex) => {
                const key = `${timeIndex}-${dayIndex}`;
                const dutyInfo = dutyData[key];
                if (dutyInfo && dutyInfo.item) {
                    items.add(dutyInfo.item);
                }
            });
            return Array.from(items);
        }
        
        // ä¸ºæ—¶é—´æ®µæ·»åŠ é¡¹ç›®
        function addItemToTimeSlot(timeIndex) {
            const availableDutyItems = dutyDataCache.getAvailableDutyItems();
            const existingItems = getItemsForTimeSlot(timeIndex);
            
            // è¿‡æ»¤æ‰å·²å­˜åœ¨çš„é¡¹ç›®
            const filteredItems = availableDutyItems.filter(item => !existingItems.includes(item));
            
            if (availableDutyItems.length === 0) {
                toast.error('è¯·å…ˆåœ¨å€¼æ—¥é¡¹ç›®è®¾ç½®ä¸­æ·»åŠ å€™é€‰é¡¹ç›®', 'æ— å¯é€‰é¡¹ç›®');
                return;
            }
            
            if (filteredItems.length === 0) {
                toast.error('è¯¥æ—¶é—´æ®µå·²åŒ…å«æ‰€æœ‰å¯ç”¨çš„å€¼æ—¥é¡¹ç›®', 'æ— å¯æ·»åŠ é¡¹ç›®');
                return;
            }
            
            // åˆ›å»ºé€‰æ‹©åˆ—è¡¨
            let options = '';
            filteredItems.forEach(item => {
                options += `<option value="${item}">${item}</option>`;
            });
            
            // åˆ›å»ºé€‰æ‹©æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>é€‰æ‹©å€¼æ—¥é¡¹ç›®</h3>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>é€‰æ‹©è¦æ·»åŠ çš„å€¼æ—¥é¡¹ç›®ï¼š</label>
                            <select id="selectDutyItem" class="form-control">
                                <option value="">è¯·é€‰æ‹©é¡¹ç›®</option>
                                ${options}
                            </select>
                        </div>
                        <div class="form-actions" style="margin-top: 20px; text-align: right;">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="confirmAddItemToTimeSlot(${timeIndex}, this.closest('.modal'))">ç¡®è®¤æ·»åŠ </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function confirmAddItemToTimeSlot(timeIndex, modal) {
            const select = modal.querySelector('#selectDutyItem');
            const itemName = select.value;
            
            if (!itemName) {
                toast.error('è¯·é€‰æ‹©ä¸€ä¸ªé¡¹ç›®', 'é€‰æ‹©é”™è¯¯');
                return;
            }
            
            // æ‰¾åˆ°è¯¥æ—¶é—´æ®µçš„ç¬¬ä¸€ä¸ªç©ºé—²å¤©æ¥æ·»åŠ é¡¹ç›®
            const timeSlots = dutyDataCache.getTimeSlots();
            let targetDayIndex = -1;
            
            // éå†ä¸€å‘¨çš„æ¯ä¸€å¤©ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºé—²çš„å¤©
            for (let dayIndex = 0; dayIndex < weekDays.length; dayIndex++) {
                const key = `${timeIndex}-${dayIndex}`;
                const existingData = dutyDataCache.getDutyData()[key];
                if (!existingData) {
                    targetDayIndex = dayIndex;
                    break;
                }
            }
            
            if (targetDayIndex === -1) {
                toast.error('è¯¥æ—¶é—´æ®µæ‰€æœ‰å¤©éƒ½å·²æœ‰å®‰æ’ï¼Œæ— æ³•æ·»åŠ æ›´å¤šé¡¹ç›®', 'æ·»åŠ å¤±è´¥');
                modal.remove();
                return;
            }
            
            const key = `${timeIndex}-${targetDayIndex}`;
            const dutyInfo = {
                item: itemName,
                person: '',
                time: `${timeSlots[timeIndex].start}-${timeSlots[timeIndex].end}`
            };
            
            dutyDataCache.setDutyAssignment(key, dutyInfo);
            renderDutyTable();
            modal.remove();
            toast.success('é¡¹ç›®æ·»åŠ æˆåŠŸï¼', 'æ·»åŠ æˆåŠŸ');
        }
        
        // æ·»åŠ æ–°æ—¶é—´æ®µ
        function addNewTimeSlot() {
            renderTimeSlotList();
            const modalElement = document.getElementById('timeSlotListModal');
            modalElement.style.display = 'flex';
        }
        
        // å…³é—­æ—¶é—´æ®µåˆ—è¡¨æ¨¡æ€æ¡†
        function closeTimeSlotListModal() {
            const modalElement = document.getElementById('timeSlotListModal');
            modalElement.style.display = 'none';
        }
        
        // æ¸²æŸ“æ—¶é—´æ®µåˆ—è¡¨ï¼ˆæ˜¾ç¤ºæ—¶é—´ç®¡ç†ä¸­çš„æ—¶é—´æ®µï¼‰
        function renderTimeSlotList() {
            const list = document.getElementById('timeSlotList');
            list.innerHTML = '';
            
            // æ˜¾ç¤ºæ—¶é—´ç®¡ç†ä¸­æ·»åŠ çš„æ—¶é—´æ®µ
            const timeSlots = dutyDataCache.getTimeSlots();
            
            if (timeSlots.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æš‚æ— æ—¶é—´æ®µï¼Œè¯·å…ˆåœ¨æ—¶é—´ç®¡ç†ä¸­æ·»åŠ </div>';
                return;
            }
            
            timeSlots.forEach((slot, index) => {
                const item = document.createElement('div');
                item.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #e5e5e7; border-radius: 6px; margin-bottom: 8px; background: #e8f5e8;';
                item.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 500; margin-bottom: 4px;">${slot.name}</div>
                        <div style="font-size: 12px; color: #666;">${slot.start} - ${slot.end}</div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-success" style="padding: 4px 8px; font-size: 12px;" onclick="selectExistingTimeSlot(${index})">ä½¿ç”¨æ­¤æ—¶é—´æ®µ</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        // ä»åˆ—è¡¨æ·»åŠ æ—¶é—´æ®µåˆ°å€™é€‰æ± 
        function addTimeSlotFromList() {
            const name = document.getElementById('timeSlotName').value.trim();
            const start = document.getElementById('timeSlotStart').value;
            const end = document.getElementById('timeSlotEnd').value;
            
            if (!name) {
                toast.error('è¯·è¾“å…¥æ—¶é—´æ®µåç§°', 'è¾“å…¥é”™è¯¯');
                return;
            }
            
            if (!start || !end) {
                toast.error('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¶é—´', 'è¾“å…¥é”™è¯¯');
                return;
            }
            
            const availableTimeSlots = dutyDataCache.getAvailableTimeSlots();
            
            if (availableTimeSlots.some(slot => slot.name === name)) {
                toast.error('è¯¥æ—¶é—´æ®µå·²å­˜åœ¨', 'æ·»åŠ å¤±è´¥');
                return;
            }
            
            const newTimeSlot = {
                name: name,
                start: start,
                end: end,
                type: 'custom'
            };
            
            dutyDataCache.addAvailableTimeSlot(newTimeSlot);
            renderTimeSlotList();
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('timeSlotName').value = '';
            document.getElementById('timeSlotStart').value = '';
            document.getElementById('timeSlotEnd').value = '';
            
            toast.success('æ—¶é—´æ®µæ·»åŠ åˆ°å€™é€‰æ± æˆåŠŸï¼', 'æ·»åŠ æˆåŠŸ');
        }
        
        // é€‰æ‹©ç°æœ‰æ—¶é—´æ®µ
        function selectExistingTimeSlot(timeIndex) {
            // å…³é—­æ—¶é—´æ®µé€‰æ‹©æ¨¡æ€æ¡†
            closeTimeSlotListModal();
            
            // ç›´æ¥æ‰“å¼€é¡¹ç›®é€‰æ‹©æ¨¡æ€æ¡†
            addItemToTimeSlot(timeIndex);
        }
        
        // é€‰æ‹©æ—¶é—´æ®µåˆ°è¡¨æ ¼ï¼ˆä¿ç•™åŸåŠŸèƒ½ï¼‰
        function selectTimeSlot(index) {
            const availableTimeSlots = dutyDataCache.getAvailableTimeSlots();
            const timeSlots = dutyDataCache.getTimeSlots();
            
            const slot = availableTimeSlots[index];
            if (!timeSlots.some(activeSlot => activeSlot.name === slot.name)) {
                timeSlots.push(slot);
                dutyDataCache.setTimeSlots(timeSlots);
                renderTimeSlotList();
                renderDutyTable();
                toast.success(`æ—¶é—´æ®µ"${slot.name}"å·²æ·»åŠ åˆ°è¡¨æ ¼ï¼`, 'æ·»åŠ æˆåŠŸ');
            }
        }
        
        // å–æ¶ˆé€‰æ‹©æ—¶é—´æ®µ
        function unselectTimeSlot(slotName) {
            const timeSlots = dutyDataCache.getTimeSlots();
            const index = timeSlots.findIndex(slot => slot.name === slotName);
            if (index >= 0) {
                timeSlots.splice(index, 1);
                dutyDataCache.setTimeSlots(timeSlots);
                renderTimeSlotList();
                renderDutyTable();
                toast.success(`æ—¶é—´æ®µ"${slotName}"å·²ä»è¡¨æ ¼ä¸­ç§»é™¤ï¼`, 'ç§»é™¤æˆåŠŸ');
            }
        }
        
        // åˆ é™¤å€™é€‰æ—¶é—´æ®µ
        function removeAvailableTimeSlot(index) {
            const slot = availableTimeSlots[index];
            // å¦‚æœæ—¶é—´æ®µæ­£åœ¨ä½¿ç”¨ï¼Œå…ˆä»è¡¨æ ¼ä¸­ç§»é™¤
            const activeIndex = timeSlots.findIndex(activeSlot => activeSlot.name === slot.name);
            if (activeIndex >= 0) {
                timeSlots.splice(activeIndex, 1);
                localStorage.setItem('timeSlots', JSON.stringify(timeSlots));
            }
            
            availableTimeSlots.splice(index, 1);
            localStorage.setItem('availableTimeSlots', JSON.stringify(availableTimeSlots));
            renderTimeSlotList();
            renderDutyTable();
            toast.success(`æ—¶é—´æ®µ"${slot.name}"å·²åˆ é™¤ï¼`, 'åˆ é™¤æˆåŠŸ');
        }
        
        // åˆ é™¤æ—¶é—´æ®µ
        async function removeTimeSlot(index) {
            const confirmed = await confirm.delete(`ç¡®å®šè¦åˆ é™¤"${timeSlots[index].name}"æ—¶é—´æ®µå—ï¼Ÿ`);
            if (confirmed) {
                timeSlots.splice(index, 1);
                localStorage.setItem('timeSlots', JSON.stringify(timeSlots));
                renderTimeSlotList();
                renderDutyTable();
                toast.success('æ—¶é—´æ®µåˆ é™¤æˆåŠŸï¼', 'åˆ é™¤æˆåŠŸ');
            }
        }
        
        // æ‰“å¼€åˆ†é…æ¨¡æ€æ¡†
        function openAssignModal(timeIndex, dayIndex, itemName) {
            currentCell = { timeIndex, dayIndex, itemName };
            
            // é‡ç½®èŒä½é€‰æ‹©
            const positionSelect = document.getElementById('assignPosition');
            if (positionSelect) {
                positionSelect.value = '';
            }
            
            // å¡«å……å­¦ç”Ÿé€‰é¡¹
            const studentInput = document.getElementById('assignStudent');
            const studentDatalist = document.getElementById('studentSuggestions');
            if (studentInput && studentDatalist) {
                studentDatalist.innerHTML = '';
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student;
                    studentDatalist.appendChild(option);
                });
            }
            
            // å¦‚æœå·²æœ‰åˆ†é…ï¼Œå¡«å……ç°æœ‰æ•°æ®
            const key = `${timeIndex}-${dayIndex}`;
            const dutyData = dutyDataCache.getDutyData();
            const existingDuty = dutyData[key];
            if (existingDuty) {
                if (positionSelect) positionSelect.value = existingDuty.position || '';
                if (studentInput) studentInput.value = existingDuty.person || '';
                const timeInput = document.getElementById('assignTime');
                if (timeInput) timeInput.value = existingDuty.time || '';
            } else {
                if (positionSelect) positionSelect.value = '';
                if (studentInput) studentInput.value = '';
                const timeInput = document.getElementById('assignTime');
                if (timeInput) timeInput.value = `${timeSlots[timeIndex].start}-${timeSlots[timeIndex].end}`;
            }
            
            const modalElement = document.getElementById('assignModal');
            if (modalElement) {
                modalElement.style.display = 'flex';
            }
        }




        
        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // æ˜¾ç¤ºæ—¶é—´æ®µè®¾ç½®
        function showTimePeriodSettings() {
            renderTimePeriodList();
            const modalElement = document.getElementById('timePeriodModal');
            modalElement.style.display = 'flex';
        }

        // å…³é—­æ—¶é—´æ®µè®¾ç½®
        function closeTimePeriodModal() {
            const modalElement = document.getElementById('timePeriodModal');
            modalElement.style.display = 'none';
        }

        // æ˜¾ç¤ºè´Ÿè´£äººè®¾ç½®æ¨¡æ€æ¡†
        // æ˜¾ç¤ºå€¼æ—¥é¡¹ç›®è®¾ç½®æ¨¡æ€æ¡†
        function showDutyItemSettings() {
            renderDutyItemList();
            const modalElement = document.getElementById('dutyItemModal');
            modalElement.style.display = 'flex';
        }

        // å…³é—­å€¼æ—¥é¡¹ç›®è®¾ç½®æ¨¡æ€æ¡†
        function closeDutyItemModal() {
            const modalElement = document.getElementById('dutyItemModal');
            modalElement.style.display = 'none';
        }

        // åŠ è½½å€¼æ—¥é¡¹ç›®æ•°æ®
        function loadDutyItems() {
            try {
                const saved = localStorage.getItem('dutyItems');
                if (saved) {
                    dutyItems = JSON.parse(saved);
                } else {
                    dutyItems = ['æ‰«åœ°', 'æ“¦é»‘æ¿', 'å€’åƒåœ¾', 'æ•´ç†è®²å°', 'å…³çª—é”é—¨'];
                    saveDutyItems();
                }
            } catch (e) {
                console.error('åŠ è½½å€¼æ—¥é¡¹ç›®æ•°æ®å¤±è´¥:', e);
                dutyItems = ['æ‰«åœ°', 'æ“¦é»‘æ¿', 'å€’åƒåœ¾'];
            }
        }

        // ä¿å­˜å€¼æ—¥é¡¹ç›®æ•°æ®
        function saveDutyItems() {
            try {
                localStorage.setItem('dutyItems', JSON.stringify(dutyItems));
            } catch (e) {
                console.error('ä¿å­˜å€¼æ—¥é¡¹ç›®æ•°æ®å¤±è´¥:', e);
            }
        }

        // æ¸²æŸ“å€¼æ—¥é¡¹ç›®åˆ—è¡¨
        function renderDutyItemList() {
            const list = document.getElementById('dutyItemList');
            list.innerHTML = '';
            
            const availableDutyItems = dutyDataCache.getAvailableDutyItems();
            
            if (availableDutyItems.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æš‚æ— å€™é€‰å€¼æ—¥é¡¹ç›®</div>';
                return;
            }
            
            availableDutyItems.forEach((item, index) => {
                const isUsed = isItemUsedInTable(item);
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = `display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #e5e5e7; border-radius: 6px; margin-bottom: 8px; background: ${isUsed ? '#e8f5e8' : '#fff'};`;
                itemDiv.innerHTML = `
                    <span style="flex: 1; font-size: 14px;">${item} ${isUsed ? '(å·²ä½¿ç”¨)' : ''}</span>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="selectDutyItemForTimeSlot('${item}')">é€‰æ‹©</button>
                        <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="removeAvailableDutyItem(${index})">åˆ é™¤</button>
                    </div>
                `;
                list.appendChild(itemDiv);
            });
        }
        
        // æ£€æŸ¥é¡¹ç›®æ˜¯å¦åœ¨è¡¨æ ¼ä¸­ä½¿ç”¨
        function isItemUsedInTable(itemName) {
            const dutyData = dutyDataCache.getDutyData();
            for (const key in dutyData) {
                if (dutyData[key].item === itemName) {
                    return true;
                }
            }
            return false;
        }

        // æ·»åŠ å€¼æ—¥é¡¹ç›®åˆ°å€™é€‰æ± 
        function addDutyItem() {
            const name = document.getElementById('dutyItemName').value.trim();
            
            if (!name) {
                toast.error('è¯·è¾“å…¥é¡¹ç›®åç§°', 'è¾“å…¥é”™è¯¯');
                return;
            }
            
            const availableDutyItems = dutyDataCache.getAvailableDutyItems();
            
            if (availableDutyItems.includes(name)) {
                toast.error('è¯¥é¡¹ç›®å·²å­˜åœ¨', 'æ·»åŠ å¤±è´¥');
                return;
            }
            
            dutyDataCache.addAvailableDutyItem(name);
            renderDutyItemList();
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('dutyItemName').value = '';
            
            toast.success('é¡¹ç›®æ·»åŠ åˆ°å€™é€‰æ± æˆåŠŸï¼', 'æ·»åŠ æˆåŠŸ');
        }

        // é€‰æ‹©å€¼æ—¥é¡¹ç›®åˆ°æ—¶é—´æ®µ
        function selectDutyItemForTimeSlot(itemName) {
            // ä»ç¼“å­˜ç³»ç»Ÿè·å–æ—¶é—´æ®µæ•°æ®
            const timeSlots = dutyDataCache.getTimeSlots();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ—¶é—´æ®µ
            if (timeSlots.length === 0) {
                toast.error('è¯·å…ˆæ·»åŠ æ—¶é—´æ®µ', 'æ“ä½œå¤±è´¥');
                return;
            }
            
            // å…³é—­å€¼æ—¥é¡¹ç›®æ¨¡æ€æ¡†
            closeDutyItemModal();
            
            // åˆ›å»ºæ—¶é—´æ®µå’Œæ—¥æœŸé€‰æ‹©ç•Œé¢
            let optionsHtml = '<div style="margin-bottom: 15px;"><strong>é€‰æ‹©è¦æ·»åŠ åˆ°çš„ä½ç½®ï¼š</strong></div>';
            
            timeSlots.forEach((timeSlot, timeIndex) => {
                optionsHtml += `<div style="margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">`;
                optionsHtml += `<div style="font-weight: bold; margin-bottom: 8px;">${timeSlot.name} (${timeSlot.start}-${timeSlot.end})</div>`;
                
                const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
                weekdays.forEach((day, dayIndex) => {
                    const key = `${timeIndex}-${dayIndex}`;
                    const existingDuty = dutyDataCache.getDutyAssignment(key);
                    const isOccupied = existingDuty && existingDuty.item;
                    
                    optionsHtml += `<button class="btn ${isOccupied ? 'btn-secondary' : 'btn-outline-primary'}" 
                        style="margin: 2px; padding: 5px 10px; font-size: 12px;" 
                        ${isOccupied ? 'disabled' : `onclick="confirmSelectDutyItem('${itemName}', '${key}', '${timeSlot.name}', '${day}')"`}>
                        ${day}${isOccupied ? ' (å·²å ç”¨)' : ''}
                    </button>`;
                });
                
                optionsHtml += '</div>';
            });
            
            // æ˜¾ç¤ºé€‰æ‹©å¯¹è¯æ¡†
            modal.show({
                title: 'é€‰æ‹©æ·»åŠ ä½ç½®',
                content: optionsHtml,
                showCancel: true,
                cancelText: 'å–æ¶ˆ',
                confirmText: 'å…³é—­',
                onConfirm: () => {
                    // é‡æ–°æ‰“å¼€å€¼æ—¥é¡¹ç›®æ¨¡æ€æ¡†
                    openDutyItemModal();
                }
            });
        }
        
        // ç¡®è®¤é€‰æ‹©å€¼æ—¥é¡¹ç›®ä½ç½®
        function confirmSelectDutyItem(itemName, key, timeSlotName, dayName) {
            const timeSlots = dutyDataCache.getTimeSlots();
            const [timeIndex] = key.split('-').map(Number);
            const timeSlot = timeSlots[timeIndex];
            
            const dutyInfo = {
                item: itemName,
                person: '',
                time: timeSlot ? `${timeSlot.start}-${timeSlot.end}` : ''
            };
            
            // ä½¿ç”¨ç¼“å­˜ç³»ç»Ÿä¿å­˜å€¼æ—¥åˆ†é…
            dutyDataCache.setDutyAssignment(key, dutyInfo);
            renderDutyTable();
            
            // å…³é—­æ¨¡æ€æ¡†
            modal.hide();
            
            toast.success(`é¡¹ç›®"${itemName}"å·²æ·»åŠ åˆ°${timeSlotName} ${dayName}ï¼`, 'æ·»åŠ æˆåŠŸ');
            
            // é‡æ–°æ‰“å¼€å€¼æ—¥é¡¹ç›®æ¨¡æ€æ¡†ä»¥ä¾¿ç»§ç»­æ“ä½œ
            setTimeout(() => {
                openDutyItemModal();
            }, 500);
        }

        // åˆ é™¤å€™é€‰å€¼æ—¥é¡¹ç›®
        async function removeAvailableDutyItem(index) {
            const availableDutyItems = dutyDataCache.getAvailableDutyItems();
            const itemName = availableDutyItems[index];
            const confirmed = await confirm.delete(`ç¡®å®šè¦åˆ é™¤"${itemName}"å—ï¼Ÿ`);
            if (confirmed) {
                // å¦‚æœé¡¹ç›®æ­£åœ¨ä½¿ç”¨ï¼Œå…ˆä»è¡¨æ ¼ä¸­ç§»é™¤
                const dutyData = dutyDataCache.getDutyData();
                for (const key in dutyData) {
                    if (dutyData[key].item === itemName) {
                        dutyDataCache.removeDutyAssignment(key);
                    }
                }
                
                // ä½¿ç”¨ç¼“å­˜ç³»ç»Ÿåˆ é™¤å€™é€‰é¡¹ç›®
                dutyDataCache.removeAvailableDutyItem(itemName);
                renderDutyItemList();
                renderDutyTable();
                toast.success('é¡¹ç›®åˆ é™¤æˆåŠŸï¼', 'åˆ é™¤æˆåŠŸ');
            }
        }





        // æ‰“å¼€åˆ†é…æ¨¡æ€æ¡†
        // æ–°çš„èŒä½åˆ†é…æ¨¡æ€æ¡†å‡½æ•° - é€‚åº”ä¼ ç»Ÿå€¼æ—¥ç”Ÿè¡¨æ ¼å¼
        function openPositionAssignModal(positionName, dayIndex) {
            currentCell = { positionName, dayIndex };
            
            // è®¾ç½®èŒä½ï¼ˆå›ºå®šä¸å¯æ›´æ”¹ï¼‰
            const positionSelect = document.getElementById('assignPosition');
            positionSelect.innerHTML = `<option value="${positionName}">${positionName}</option>`;
            positionSelect.value = positionName;
            positionSelect.disabled = true;
            
            // å¡«å……å­¦ç”Ÿé€‰é¡¹
            const studentSelect = document.getElementById('assignStudent');
            studentSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å­¦ç”Ÿ</option>';
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student;
                option.textContent = student;
                studentSelect.appendChild(option);
            });
            
            // æŸ¥æ‰¾è¯¥èŒä½åœ¨è¯¥å¤©æ˜¯å¦å·²æœ‰åˆ†é…
            let existingPerson = '';
            let existingTime = '';
            let existingTimeIndex = -1;
            
            for (let timeIndex = 0; timeIndex < timeSlots.length; timeIndex++) {
                const key = `${timeIndex}-${dayIndex}`;
                const dutyInfo = dutyData[key];
                if (dutyInfo && dutyInfo.position === positionName) {
                    existingPerson = dutyInfo.person || '';
                    existingTime = dutyInfo.time || '';
                    existingTimeIndex = timeIndex;
                    break;
                }
            }
            
            // å¡«å……ç°æœ‰æ•°æ®
            document.getElementById('assignStudent').value = existingPerson;
            document.getElementById('assignTime').value = existingTime;
            
            // å­˜å‚¨å½“å‰ç¼–è¾‘çš„æ—¶é—´æ®µç´¢å¼•
            currentCell.existingTimeIndex = existingTimeIndex;
            
            const modalElement = document.getElementById('assignModal');
            modalElement.style.display = 'flex';
        }
        
        // ä¿ç•™åŸæœ‰å‡½æ•°ä»¥å…¼å®¹å…¶ä»–åŠŸèƒ½
        function openAssignModal(timeIndex, dayIndex, itemName) {
            currentCell = { timeIndex, dayIndex, itemName };
            
            // é‡ç½®èŒä½é€‰æ‹©
            const positionSelect = document.getElementById('assignPosition');
            if (positionSelect) {
                positionSelect.value = '';
            }
            
            // æ›´æ–°å­¦ç”Ÿå»ºè®®åˆ—è¡¨
            updateStudentSuggestions();
            
            // å¦‚æœå·²æœ‰åˆ†é…ï¼Œå¡«å……ç°æœ‰æ•°æ®
            const key = `${timeIndex}-${dayIndex}`;
            const dutyData = dutyDataCache.getDutyData();
            const existingDuty = dutyData[key];
            if (existingDuty) {
                document.getElementById('assignPosition').value = existingDuty.position || '';
                document.getElementById('assignStudent').value = existingDuty.person || '';
                document.getElementById('assignTime').value = existingDuty.time || '';
            } else {
                document.getElementById('assignPosition').value = '';
                document.getElementById('assignStudent').value = '';
                document.getElementById('assignTime').value = '';
            }
            
            const modalElement = document.getElementById('assignModal');
            modalElement.style.display = 'flex';
        }

        // å…³é—­åˆ†é…æ¨¡æ€æ¡†
        function closeAssignModal() {
            const modalElement = document.getElementById('assignModal');
            modalElement.style.display = 'none';
            currentCell = null;
        }

        // ç¡®è®¤åˆ†é…
        function confirmAssign() {
            if (!currentCell) return;
            
            const position = document.getElementById('assignPosition').value;
            const person = document.getElementById('assignStudent').value;
            const time = document.getElementById('assignTime').value;
            const key = `${currentCell.timeIndex}-${currentCell.dayIndex}`;
            
            if (!person) {
                // åˆ é™¤åˆ†é…
                dutyDataCache.removeDutyAssignment(key);
            } else {
                // ä¿å­˜æ–°åˆ†é…
                const timeSlots = dutyDataCache.getTimeSlots();
                
                // è·å–itemä¿¡æ¯ï¼šä¼˜å…ˆä½¿ç”¨currentCell.itemNameï¼Œå¦‚æœæ²¡æœ‰åˆ™ä»ç°æœ‰æ•°æ®è·å–
                let itemName = currentCell.itemName;
                if (!itemName) {
                    const existingDuty = dutyDataCache.getDutyAssignment(key);
                    itemName = existingDuty ? existingDuty.item : '';
                }
                
                const assignment = {
                    item: itemName,
                    position: position,
                    person: person,
                    time: time || `${timeSlots[currentCell.timeIndex].start}-${timeSlots[currentCell.timeIndex].end}`
                };
                dutyDataCache.setDutyAssignment(key, assignment);
            }
            
            renderDutyTable();
            closeAssignModal();
            
            toast.success('åˆ†é…æˆåŠŸï¼', 'æ“ä½œæˆåŠŸ');
        }

        // æ£€æŸ¥äººå‘˜å†²çª
        function checkPersonConflict(person, timeIndex, dayIndex) {
            const currentKey = `${timeIndex}-${dayIndex}`;
            const dutyData = dutyDataCache.getDutyData();
            
            for (const key in dutyData) {
                if (key !== currentKey && dutyData[key].person === person) {
                    const [checkTimeIndex] = key.split('-').map(Number);
                    if (checkTimeIndex === timeIndex) {
                        return key;
                    }
                }
            }
            return null;
        }
        
        // æ£€æŸ¥å­¦ç”Ÿåœ¨åŒä¸€å¤©æ˜¯å¦å·²æœ‰å…¶ä»–èŒä½åˆ†é…
        function checkPersonDayConflict(person, dayIndex, currentPosition) {
            const dutyData = dutyDataCache.getDutyData();
            
            for (const key in dutyData) {
                const [timeIndex, checkDayIndex] = key.split('-').map(Number);
                if (checkDayIndex === dayIndex && dutyData[key].person === person) {
                    const existingPosition = dutyData[key].position;
                    if (existingPosition !== currentPosition) {
                        return existingPosition;
                    }
                }
            }
            return null;
        }

        // éªŒè¯å•å…ƒæ€»æ•°
        function validateCellCount() {
            const timeSlots = dutyDataCache.getTimeSlots();
            const students = studentListCache.getAll();
            const totalCells = timeSlots.length * weekDays.length;
            const studentCount = students.length;
            
            if (totalCells > studentCount && studentCount > 0) {
                return {
                    valid: false,
                    message: `æ€»å•å…ƒæ•°(${totalCells})è¶…è¿‡ç­çº§äººæ•°(${studentCount})ï¼Œæ— æ³•å®Œæˆåˆ†é…`
                };
            }
            
            return { valid: true };
        }



        // å¯¼å‡ºå€¼æ—¥ç”Ÿè¡¨
        function exportDutyTable() {
            const timeSlots = dutyDataCache.getTimeSlots();
            const dutyData = dutyDataCache.getDutyData();
            
            let csv = 'æ—¶é—´æ®µ,' + weekDays.join(',') + '\n';
            
            timeSlots.forEach((timeSlot, timeIndex) => {
                const timeStr = `${timeSlot.name}(${timeSlot.start}-${timeSlot.end})`;
                let row = `"${timeStr}"`;
                
                weekDays.forEach((day, dayIndex) => {
                    const key = `${timeIndex}-${dayIndex}`;
                    const dutyInfo = dutyData[key];
                    let content = '';
                    
                    if (dutyInfo) {
                        content = `${dutyInfo.position || ''}\n${dutyInfo.person || ''}\n${dutyInfo.time || ''}`;
                    }
                    
                    row += ',"' + content.replace(/"/g, '""') + '"';
                });
                
                csv += row + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'å€¼æ—¥ç”Ÿè¡¨.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            toast.success('å€¼æ—¥ç”Ÿè¡¨å¯¼å‡ºæˆåŠŸï¼', 'å¯¼å‡ºæˆåŠŸ');
        }

        // å¯¼å…¥å€¼æ—¥ç”Ÿè¡¨
        function importDutyTable() {
            document.getElementById('fileInput').click();
        }

        // å¯¼å…¥å€¼æ—¥æ•°æ®
        function importDutyData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        toast.error('CSVæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'å¯¼å…¥å¤±è´¥');
                        return;
                    }
                    
                    // è§£ææ•°æ®
                    const newDutyData = {};
                    
                    for (let i = 1; i < lines.length; i++) {
                        const cells = parseCSVLine(lines[i]);
                        if (cells.length < 2) continue;
                        
                        const timeIndex = i - 1;
                        
                        for (let j = 1; j < cells.length && j - 1 < weekDays.length; j++) {
                            const dayIndex = j - 1;
                            const content = cells[j].trim();
                            
                            if (content) {
                                const parts = content.split('\n');
                                const key = `${timeIndex}-${dayIndex}`;
                                newDutyData[key] = {
                                    position: parts[0] || '',
                                    person: parts[1] || '',
                                    time: parts[2] || ''
                                };
                            }
                        }
                    }
                    
                    dutyData = newDutyData;
                    saveDutyData();
                    renderDutyTable();
    
                    
                    toast.success('å€¼æ—¥ç”Ÿè¡¨å¯¼å…¥æˆåŠŸï¼', 'å¯¼å…¥æˆåŠŸ');
                } catch (e) {
                    console.error('å¯¼å…¥å¤±è´¥:', e);
                    toast.error('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'å¯¼å…¥å¤±è´¥');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
            event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
        }

        // è§£æCSVè¡Œ
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        // é‡ç½®æ‰€æœ‰æ•°æ®
        async function resetAllData() {
            const confirmed = await confirm.delete('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†æ¸…ç©ºæ—¶é—´æ®µã€å€¼æ—¥é¡¹ç›®ã€åˆ†é…æ•°æ®ç­‰æ‰€æœ‰å†…å®¹ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚');
            if (confirmed) {
                // æ¸…ç©ºæ‰€æœ‰localStorageæ•°æ®
                localStorage.removeItem('timeSlots');
                localStorage.removeItem('availableTimeSlots');
                localStorage.removeItem('dutyData');
                localStorage.removeItem('dutyItems');
                localStorage.removeItem('availableDutyItems');
                localStorage.removeItem('studentList');
                localStorage.removeItem('dutyPositions');
                localStorage.removeItem('customTimePeriods');
                
                // é‡ç½®æ‰€æœ‰å˜é‡
                timeSlots = [];
                availableTimeSlots = [];
                dutyData = {};
                dutyItems = [];
                availableDutyItems = [];
                students = [];
                positions = [];
                customTimePeriods = [];
                
                // é‡æ–°æ¸²æŸ“
                renderDutyTable();
                
                toast.success('æ‰€æœ‰æ•°æ®å·²é‡ç½®ï¼', 'é‡ç½®æˆåŠŸ');
            }
        }
        
        // æ¸…ç©ºå€¼æ—¥ç”Ÿè¡¨
        async function clearDutyTable() {
            const confirmed = await confirm.delete('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å€¼æ—¥ç”Ÿè¡¨æ•°æ®å’Œæ—¶é—´æ®µå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚');
            if (confirmed) {
                // ä½¿ç”¨ç¼“å­˜ç³»ç»Ÿæ¸…ç©ºå€¼æ—¥æ•°æ®å’Œæ—¶é—´æ®µ
                dutyDataCache.clearDutyData();
                dutyDataCache.setTimeSlots([]);
                renderDutyTable();
                toast.success('å€¼æ—¥ç”Ÿè¡¨å’Œæ—¶é—´æ®µå·²æ¸…ç©º', 'æ¸…ç©ºæˆåŠŸ');
            }
        }
        
        // ä»è¡¨æ ¼ä¸­åˆ é™¤æ—¶é—´æ®µ
         async function removeTimeSlotFromTable(timeIndex) {
             const timeSlots = dutyDataCache.getTimeSlots();
             const timeSlot = timeSlots[timeIndex];
             
             const confirmed = await confirm.delete(`ç¡®å®šè¦åˆ é™¤æ—¶é—´æ®µ"${timeSlot.name}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`);
             if (confirmed) {
                 // è·å–æ‰€æœ‰å€¼æ—¥åˆ†é…æ•°æ®
                 const dutyData = dutyDataCache.getDutyData();
                 const newDutyData = {};
                 
                 // é‡æ–°æ„å»ºå€¼æ—¥åˆ†é…æ•°æ®ï¼Œè°ƒæ•´ç´¢å¼•
                 for (const key in dutyData) {
                     const [keyTimeIndex, dayIndex] = key.split('-').map(Number);
                     
                     if (keyTimeIndex < timeIndex) {
                         // åœ¨åˆ é™¤çš„æ—¶é—´æ®µä¹‹å‰ï¼Œç´¢å¼•ä¸å˜
                         newDutyData[key] = dutyData[key];
                     } else if (keyTimeIndex > timeIndex) {
                         // åœ¨åˆ é™¤çš„æ—¶é—´æ®µä¹‹åï¼Œç´¢å¼•å‡1
                         const newKey = `${keyTimeIndex - 1}-${dayIndex}`;
                         newDutyData[newKey] = dutyData[key];
                     }
                     // keyTimeIndex === timeIndex çš„æ•°æ®è¢«åˆ é™¤ï¼ˆä¸å¤åˆ¶ï¼‰
                 }
                 
                 // åˆ é™¤æ—¶é—´æ®µ
                 timeSlots.splice(timeIndex, 1);
                 dutyDataCache.setTimeSlots(timeSlots);
                 
                 // æ›´æ–°å€¼æ—¥åˆ†é…æ•°æ®
                 dutyDataCache.setDutyData(newDutyData);
                 
                 renderDutyTable();
                 toast.success(`æ—¶é—´æ®µ"${timeSlot.name}"å·²åˆ é™¤`, 'åˆ é™¤æˆåŠŸ');
             }
         }

        // é‡ç½®ä¸ºé»˜è®¤å€¼æ—¥é¡¹ç›®
        // è¿”å›ä¸Šä¸€é¡µ
        function goBack() {
            window.history.back();
        }



        // æ—¶é—´æ®µç®¡ç†å‡½æ•°
        function loadTimePeriods() {
            const saved = localStorage.getItem('customTimePeriods');
            if (saved) {
                try {
                    customTimePeriods = JSON.parse(saved);
                } catch (e) {
                    console.error('åŠ è½½æ—¶é—´æ®µæ•°æ®å¤±è´¥:', e);
                    customTimePeriods = [];
                }
            }
        }

        function saveTimePeriods() {
            localStorage.setItem('customTimePeriods', JSON.stringify(customTimePeriods));
        }

        function renderTimePeriodList() {
            const container = document.getElementById('timePeriodList');
            if (!container) return;
            
            container.innerHTML = '';
            
            // ä»ç¼“å­˜ç³»ç»Ÿè·å–æ—¶é—´æ®µæ•°æ®
            const timeSlots = dutyDataCache.getTimeSlots();
            timeSlots.forEach((slot, index) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="item-info">
                        <div class="item-name">${slot.name}</div>
                        <div class="item-detail">${slot.start} - ${slot.end}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editTimePeriod(${index})">
                            <i class="fas fa-edit"></i> ç¼–è¾‘
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="removeTimePeriod(${index})">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function addNewTimePeriod() {
            const name = document.getElementById('timePeriodName').value.trim();
            const start = document.getElementById('timePeriodStart').value;
            const end = document.getElementById('timePeriodEnd').value;
            
            if (!name || !start || !end) {
                toast.error('è¯·å¡«å†™å®Œæ•´çš„æ—¶é—´æ®µä¿¡æ¯', 'æ·»åŠ å¤±è´¥');
                return;
            }
            
            if (start >= end) {
                toast.error('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´', 'æ—¶é—´é”™è¯¯');
                return;
            }
            
            // ä»ç¼“å­˜ç³»ç»Ÿè·å–ç°æœ‰æ—¶é—´æ®µ
            const timeSlots = dutyDataCache.getTimeSlots();
            
            // æ£€æŸ¥æ˜¯å¦é‡å¤
            const exists = timeSlots.some(slot => 
                slot.name === name || 
                (slot.start === start && slot.end === end)
            );
            
            if (exists) {
                toast.error('æ—¶é—´æ®µåç§°æˆ–æ—¶é—´èŒƒå›´å·²å­˜åœ¨', 'æ·»åŠ å¤±è´¥');
                return;
            }
            
            const newTimeSlot = {
                name: name,
                start: start,
                end: end,
                type: 'custom'
            };
            
            // ä½¿ç”¨ç¼“å­˜ç³»ç»Ÿæ·»åŠ æ—¶é—´æ®µåˆ°æ­£åœ¨ä½¿ç”¨çš„æ—¶é—´æ®µåˆ—è¡¨
            const currentTimeSlots = dutyDataCache.getTimeSlots();
            currentTimeSlots.push(newTimeSlot);
            dutyDataCache.setTimeSlots(currentTimeSlots);
            renderTimePeriodList();
            renderDutyTable();
            clearTimePeriodForm();
            renderDutyTable();
            toast.success('æ—¶é—´æ®µæ·»åŠ æˆåŠŸ', 'æ·»åŠ æˆåŠŸ');
        }

        function clearTimePeriodForm() {
            document.getElementById('timePeriodName').value = '';
            document.getElementById('timePeriodStart').value = '';
            document.getElementById('timePeriodEnd').value = '';
        }

        function editTimePeriod(index) {
            const slot = timeSlots[index];
            document.getElementById('timePeriodName').value = slot.name;
            document.getElementById('timePeriodStart').value = slot.start;
            document.getElementById('timePeriodEnd').value = slot.end;
            
            // åˆ é™¤åŸæ—¶é—´æ®µ
            timeSlots.splice(index, 1);
            localStorage.setItem('timeSlots', JSON.stringify(timeSlots));
            renderTimePeriodList();
            renderDutyTable();

        }

        async function removeTimePeriod(index) {
            const slot = timeSlots[index];
            const confirmed = await confirm.delete(`ç¡®å®šè¦åˆ é™¤æ—¶é—´æ®µ"${slot.name}"å—ï¼Ÿ`);
            if (confirmed) {
                timeSlots.splice(index, 1);
                localStorage.setItem('timeSlots', JSON.stringify(timeSlots));
                renderTimePeriodList();
                renderDutyTable();
                toast.success('æ—¶é—´æ®µåˆ é™¤æˆåŠŸ', 'åˆ é™¤æˆåŠŸ');
            }
        }




        // æ—¶é—´æ®µå¯¼å…¥å¯¼å‡ºåŠŸèƒ½
        function exportTimePeriods() {
            if (customTimePeriods.length === 0) {
                toast.warning('æ²¡æœ‰æ—¶é—´æ®µæ•°æ®å¯å¯¼å‡º', 'å¯¼å‡ºå¤±è´¥');
                return;
            }
            
            const data = JSON.stringify(customTimePeriods, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `æ—¶é—´æ®µé…ç½®_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            toast.success('æ—¶é—´æ®µé…ç½®å¯¼å‡ºæˆåŠŸ', 'å¯¼å‡ºæˆåŠŸ');
        }

        function importTimePeriods() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = importTimePeriodData;
            input.click();
        }

        function importTimePeriodData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data) && data.every(item => 
                        item.name && item.start && item.end
                    )) {
                        customTimePeriods = data;
                        saveTimePeriods();
                        renderTimePeriodList();
                        updateDutyTable();

                        toast.success(`æˆåŠŸå¯¼å…¥${data.length}ä¸ªæ—¶é—´æ®µ`, 'å¯¼å…¥æˆåŠŸ');
                    } else {
                        toast.error('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'å¯¼å…¥å¤±è´¥');
                    }
                } catch (error) {
                    toast.error('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'å¯¼å…¥å¤±è´¥');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }

        async function clearAllTimePeriods() {
            if (customTimePeriods.length === 0) {
                toast.warning('æ²¡æœ‰æ—¶é—´æ®µéœ€è¦æ¸…ç©º', 'æç¤º');
                return;
            }
            
            const confirmed = await confirm.delete(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰${customTimePeriods.length}ä¸ªæ—¶é—´æ®µå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`);
            if (confirmed) {
                customTimePeriods = [];
                saveTimePeriods();
                renderTimePeriodList();
                updateDutyTable();
                toast.success('æ‰€æœ‰æ—¶é—´æ®µå·²æ¸…ç©º', 'æ¸…ç©ºæˆåŠŸ');
            }
        }



        // è‡ªå®šä¹‰æç¤ºæ¡†
        async function customPrompt(title, message, defaultValue = '') {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>${title}</h3>
                        </div>
                        <div class="modal-body">
                            <p>${message}</p>
                            <input type="text" id="promptInput" value="${defaultValue}" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
                            <div style="text-align: right; margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="closePrompt(null)">å–æ¶ˆ</button>
                                <button class="btn btn-primary" onclick="closePrompt(document.getElementById('promptInput').value)" style="margin-left: 10px;">ç¡®å®š</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                document.getElementById('promptInput').focus();
                
                window.closePrompt = function(value) {
                    document.body.removeChild(modal);
                    delete window.closePrompt;
                    resolve(value);
                };
                
                // å›è½¦ç¡®è®¤
                document.getElementById('promptInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        closePrompt(this.value);
                    }
                });
            });
        }
        
        // ç¼–è¾‘æ¨¡å¼ç›¸å…³å˜é‡å’Œå‡½æ•°
        let isEditMode = false;
        let dutyDataBackup = {};
        
        // ç¼–è¾‘æ¨¡å¼åˆ‡æ¢
        async function toggleEditMode() {
            if (isEditMode) {
                exitEditMode();
            } else {
                // è¿›å…¥ç¼–è¾‘æ¨¡å¼å‰éœ€è¦å®‰å…¨éªŒè¯
                const verified = await securitySystem.verifySensitiveOperation('ä¿®æ”¹å€¼æ—¥ç”Ÿè¡¨');
                if (!verified) {
                    return;
                }
                enterEditMode();
            }
        }
        
        function enterEditMode() {
            isEditMode = true;
            dutyDataBackup = JSON.parse(JSON.stringify(dutyDataCache.getDutyData()));
            
            document.body.classList.add('edit-mode');
            document.getElementById('editModeBtn').style.display = 'none';
            document.getElementById('editControls').style.display = 'flex';
            document.getElementById('dutyToolbar').style.display = 'block';
            
            renderDutyTable();
            toast.info('å·²è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œå¯ä»¥ä¿®æ”¹å€¼æ—¥ç”Ÿè¡¨å†…å®¹', 'ç¼–è¾‘æ¨¡å¼');
        }
        
        function exitEditMode() {
            isEditMode = false;
            
            document.body.classList.remove('edit-mode');
            document.getElementById('editModeBtn').style.display = 'inline-flex';
            document.getElementById('editControls').style.display = 'none';
            document.getElementById('dutyToolbar').style.display = 'none';
            
            renderDutyTable();
            toast.info('å·²é€€å‡ºç¼–è¾‘æ¨¡å¼', 'é€€å‡ºç¼–è¾‘');
        }
        
        function saveDutyTable() {
            saveDataToLocalStorage();
            dutyDataBackup = {};
            toast.success('å€¼æ—¥ç”Ÿè¡¨å·²ä¿å­˜', 'ä¿å­˜æˆåŠŸ');
        }
        
        function cancelEdit() {
            if (Object.keys(dutyDataBackup).length > 0) {
                dutyData = JSON.parse(JSON.stringify(dutyDataBackup));
                renderDutyTable();
                toast.info('å·²æ’¤é”€æ‰€æœ‰ä¿®æ”¹', 'æ’¤é”€æˆåŠŸ');
            }
        }
    </script>
</body>
</html>